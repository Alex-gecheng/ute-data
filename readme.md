# API 接口文档

------

## 通用说明

- **请求方式**：GET / POST（以各接口说明为准）
- **数据格式**：
  - 请求：`application/json`
  - 响应：`application/json`
- **请求频率**：
  - 常规接口：**1 次 / 秒**
  - 在线巡检接口：**1 次 / 10 秒（0.1 QPS）**
- **通用返回字段说明**：

| 字段名     | 类型           | 说明                 |
| ---------- | -------------- | -------------------- |
| success    | boolean        | 请求是否成功         |
| elapsed_ms | number         | 接口处理耗时（毫秒） |
| data       | object / array | 实际业务数据         |

------

## 1. 工艺数据接口

### 接口地址

```
/api/process_data
```

### 请求方式

- `GET`
- `POST`

### 请求参数

| 参数名 | 类型   | 必填 | 说明     |
| ------ | ------ | ---- | -------- |
| code   | string | 是   | 工艺编号 |

#### 请求示例

```
/api/process_data/?code=07_4_3mz2010
```

#### cmd

```bash
curl -X POST http://localhost:5000/api/process_data \
 -H "Content-Type: application/json" \
 -d '{"code":"07_4_3mz2010"}'
```

### 返回示例

```json
{
  "success": true,
  "elapsed_ms": 48.5,
  "data": {
    "加工方式": 101,
    "砂轮序号": 51,
    "砂轮线速度": 30.0,
    "砂轮轴转速": 23885.0,
    "新砂轮直径": 28.0,
    "砂轮最小直径": 20.0,
    "砂轮修整宽度": 25.0,
    "修整速度": 500.0,
    "修整间隔": 4.0,
    "新砂轮修整量": 1.3,
    "X轴新砂轮修整量": 0.005,
    "X轴修整跳进量": 18.937,
    "新砂轮X轴起始加工位": 0.0,
    "磨架原位": 0.0,
    "磨架中位": 0.0,
    "磨架到位": 145.45,
    "工件轴转速": 350.0,
    "进给轮倍率": 1.0,
    "进给补偿": 0.001,
    "粗磨1速度": 0.07,
    "粗磨1量": 0.05,
    "粗磨2速度": 0.05,
    "粗磨2量": 0.03,
    "精磨速度": 0.03,
    "精磨量": 0.01,
    "粗回跳量": 0.0,
    "精回跳量": 0.0,
    "光磨速度": 0.01,
    "光磨量": 0.005,
    "光磨延时": 0.5,
    "快速速率": 15.0,
    "快速量": 0.21,
    "快速倍率": 0.0,
    "快进速度": 350.0,
    "快进量": 3.12,
    "振动速度": 400.0,
    "振动距离": 1.3,
    "沟位补偿": 0.001,
    "上下料位置": 2.0
  }
}
```

------

## 2. 效率数据接口

### 接口地址

```
/api/efficiency_data
```

### 请求方式

- `GET`
- `POST`

### 请求参数

| 参数名 | 类型   | 必填 | 说明            |
| ------ | ------ | ---- | --------------- |
| code   | string | 是   | 工艺 / 设备编号 |

### 请求示例

```
/api/efficiency_data/?code=xxx
```

### 返回示例

```json
{
  "success": true,
  "elapsed_ms": 44.33,
  "data": {
    "ID": 67953,
    "RecordID": 67453,
    "X轴起始加工位": 2.005,
    "Z轴起始修整位": 25.0,
    "上料等待时长": 0.82,
    "下料等待时长": 0.73,
    "修整耗时": 0.905,
    "光磨时长": 10.01,
    "快速趋近时长": 0.86,
    "快进时长": 2.81,
    "粗磨1时长": 7.93,
    "粗磨2时长": 0.04,
    "精磨时长": 4.93,
    "退刀时长": 2.37,
    "有效磨削开始时间": "Wed, 31 Jul 2024 10:22:40 GMT",
    "有效磨削时长": 23.05,
    "磨削总量": 3.44,
    "砂轮修整序号": 46,
    "砂轮现在直径": 23.99
  }
}
```

------

## 3. 首页 · 在线检验数据

> 数据来源与 **详细页在线巡检数据** 一致，主要用于首页汇总展示。

### 接口地址

```
/api/home_online_inspection
```

### 请求方式

- `POST`
- `GET`

### 请求示例

```
/api/efficiency_data/?code=xxx
```

### 请求参数

| 参数名 | 类型   | 必填 | 说明            |
| ------ | ------ | ---- | --------------- |
| code   | string | 是   | 设备 / 工艺编号 |

### 返回示例

```json
{
  "success": true,
  "elapsed_ms": 125.4,
  "data": {
    "抽检数": 5,
    "合格数": 5,
    "不合格数": 0,
    "预检不合格数": 0,
    "测量总数量": 247046,
    "合格总数量": 210278,
    "内径合格率": 85.0,
    "尺寸返工总数量": 17422,
    "尺寸报废总数量": 36506,
    "圆度返工总数量": 81,
    "锥度返工总数量": 6884
  }
}
```

------

## 4. 首页 · 首巡检数据（MES）

### 数据来源

MES 数据库（最近 3 条巡检记录）：

```sql
SELECT *
FROM ute_mes_qms_new.t_qms_sj_taskiptitem
ORDER BY id DESC
LIMIT 3;
```

### 接口地址

```
/api/home_inspection
```

### 请求方式

- `GET`

### 请求参数

- 无

### 请求示例

```bash
curl http://localhost:5000/api/home_inspection
```

### 返回示例

```json
{
  "success": true,
  "elapsed_ms": 40.96,
  "data": [
    {
      "type": "巡检",
      "抽检数": "12",
      "合格数": "12",
      "不合格数": 0
    },
    {
      "type": "巡检",
      "抽检数": "12",
      "合格数": "12",
      "不合格数": 0
    },
    {
      "type": "巡检",
      "抽检数": "14",
      "合格数": "14",
      "不合格数": 0
    }
  ]
}
```

------

## 5. 详细页 · 首巡检数据

### 接口地址

```
/api/details_inspection
```

### 请求方式

- `GET` / `POST`

### 请求参数

| 参数名 | 类型   | 必填 | 说明            |
| ------ | ------ | ---- | --------------- |
| code   | string | 是   | 产品 / 工艺编号 |

### 返回示例（模拟数据）

```json
{
  "内径尺寸标准": "φ17(-0.0005~-0.0035)",
  "内径尺寸结果": "合格",
  "垂直差标准": "0.002",
  "垂直差结果": "合格",
  "壁厚差标准": "0.0015",
  "壁厚差结果": "合格",
  "椭圆标准": "0.001",
  "椭圆结果": "合格",
  "锥度标准": "0.001",
  "锥度结果": "合格",
  "粗糙度标准": "Ra 0.2μm",
  "粗糙度结果": "合格",
  "表面质量标准": "无缺陷",
  "表面质量结果": "不合格",
  "表面质量备注": "2个生锈"
}
```

------

## 6. 详细页 · 在线巡检数据

### 接口地址

```
/api/detailed_online_inspection
```

### 请求方式

- `GET`
- `POST`

### 请求频率

- **1 次 / 10 秒（0.1 QPS）**

### 请求参数

| 参数名 | 类型   | 必填 | 说明            |
| ------ | ------ | ---- | --------------- |
| code   | string | 是   | 设备 / 工艺编号 |

### 请求示例

```
/api/detailed_online_inspection/?code=01_2_lxng_da30
```

### 返回示例

```json
{
  "success": true,
  "elapsed_ms": 46.68,
  "data": {
    "上截面圆度": 2.0,
    "上截面圆度结果": "合格",
    "上截面尺寸": -14.1,
    "上截面尺寸结果": "返工",
    "下截面圆度": 4.0,
    "下截面圆度结果": "合格",
    "下截面尺寸": -15.9,
    "下截面尺寸结果": "返工",
    "内径测量总数量": 100562,
    "内径合格总数量": 88706,
    "内径合格率": 88.0,
    "预检不合格数量": 234,
    "尺寸返工总数量": 7877,
    "尺寸报废总数量": 11622,
    "圆度返工总数量": 0,
    "锥度返工总数量": 2565,
    "设备状态": 27
  }
}
```

------





## 性能分析

sql查询表使用索引取最后一个数据，时间复杂度`O(1)`

api查询单次主要在传输时间

```
[查询成功] code=07_4_3mz2010，耗时:44.54ms
```

ssh下，并发     瓶颈在ssh传输     约20qps

```
================================================================================
测试结果统计
================================================================================
总请求数: 20
成功: 20
失败: 0
总耗时: 1.088s

process_data 接口结果:
  请求数: 10
  成功: 10
  平均响应时间: 0.909s
  最快: 0.800s
  最慢: 1.081s
  平均查询时间(API内部): 375.99ms
  返回字段数: 40

efficiency_data 接口结果:
  请求数: 10
  成功: 10
  平均响应时间: 0.962s
  最快: 0.883s
  最慢: 1.055s
  平均查询时间(API内部): 579.53ms
  返回字段数: 22
================================================================================
```

* 后续如果使用内网，去掉ssh部分，可极大提升性能
* 可适当修改数据库连接池设置和多线程数量

```
db_pool_scada = PooledDB(
        creator=pymysql,
        maxconnections=30,
        mincached=10,
        maxcached=24,
        maxshared=0,
        blocking=True,
        maxusage=0,
        setsession=[],
        ping=1,
        host='127.0.0.1',
        port=tunnel_scada.local_bind_port,
        user=DB_CONFIG_SCADA['user'],
        password=DB_CONFIG_SCADA['password'],
        database=DB_CONFIG_SCADA['database'],
        charset='utf8mb4',
        cursorclass=pymysql.cursors.DictCursor
    )
```

```
serve(app, host='0.0.0.0', port=5000, threads=32)
```

